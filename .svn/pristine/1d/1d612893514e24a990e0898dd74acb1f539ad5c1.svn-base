package oracle.bpm.workspace.client.service.impl;

import java.text.DateFormat;
import java.text.SimpleDateFormat;
import java.util.ArrayList;
import java.util.Calendar;
import java.util.HashMap;
import java.util.Iterator;
import java.util.List;
import java.util.Map;

import javax.annotation.Resource;

import org.slf4j.Logger;
import org.slf4j.LoggerFactory;
import org.springframework.stereotype.Service;
import org.w3c.dom.Element;

import oracle.bpel.services.workflow.IWorkflowConstants;
import oracle.bpel.services.workflow.query.ITaskQueryService;
import oracle.bpel.services.workflow.query.ITaskQueryService.OptionalInfo;
import oracle.bpel.services.workflow.repos.Ordering;
import oracle.bpel.services.workflow.repos.Predicate;
import oracle.bpel.services.workflow.repos.TableConstants;
import oracle.bpel.services.workflow.runtimeconfig.model.TaskDisplayInfoType;
import oracle.bpel.services.workflow.task.model.ActionType;
import oracle.bpel.services.workflow.task.model.Task;
import oracle.bpel.services.workflow.verification.IWorkflowContext;
import oracle.bpel.services.workflow.worklist.api.util.WorklistUtil;
import oracle.bpm.workspace.client.config.SOAServiceClient;
import oracle.bpm.workspace.client.constants.OracleConstants;
import oracle.bpm.workspace.client.service.CustomWorkflowService;
import oracle.bpm.workspace.client.util.CommonUtility;
import oracle.bpm.workspace.client.util.WorkflowUtility;
import oracle.bpm.workspace.client.util.XmlUtility;
import oracle.bpm.workspace.client.vo.TaskVO;

@Service("CustomWorkflowService")
public class CustomWorkflowServiceImpl implements CustomWorkflowService {
	
	@Resource(name="soaClient")
    protected SOAServiceClient soaClient;
	
	private Logger logger = LoggerFactory.getLogger(this.getClass());	// Logger

	@Override
	public List<TaskVO> getTaskList(IWorkflowContext wfCtx, Map<String, String> params) throws Exception {
		String cpage = "";
		String rowSize = "";
		
		Iterator<String> paramKeys = params.keySet().iterator();
		while( paramKeys.hasNext() ) {
            String key = paramKeys.next();
            logger.debug( String.format("task key : %s, 값 : %s", key, params.get(key)) );
        }
		
		if(params.get(OracleConstants.PARAM.PAGE.CURRENT_PAGE) == null) 
			cpage = "0";
		else
			cpage = (String) params.get(OracleConstants.PARAM.PAGE.CURRENT_PAGE);
		
		if(params.get(OracleConstants.PARAM.PAGE.CURRENT_PAGE) == null) 
			rowSize = "5";
		else
			rowSize = (String) params.get(OracleConstants.PARAM.PAGE.MAX_ROWS);
		
		int startRow = Integer.parseInt(cpage) * Integer.parseInt(rowSize) + 1;
	    int endRow = startRow + Integer.parseInt(rowSize) - 1;
	    
	    
		//조회할 컬럼을 정의한다.
		List<String> inboxColumns = new ArrayList<String>();
		
		inboxColumns.add(TableConstants.WFTASK_APPLICATIONNAME_COLUMN.getName());
		inboxColumns.add(TableConstants.WFTASK_TASKNUMBER_COLUMN.getName());	// Task Number
		inboxColumns.add(TableConstants.WFTASK_TITLE_COLUMN.getName());			// Task Title
		inboxColumns.add(TableConstants.WFTASK_ACQUIREDBY_COLUMN.getName());		// Task AcquiredBy ( 획득자 )
		inboxColumns.add(TableConstants.WFTASK_ASSIGNEEUSERS_COLUMN.getName());		// Task Assigneeusers (할당자)
		inboxColumns.add(TableConstants.WFTASK_STATE_COLUMN.getName());				// Task Status (ASSIGNED, COMPLETED...)
		inboxColumns.add(TableConstants.WFTASK_OUTCOME_COLUMN.getName());			// Task outcome (APPROVE,REJECT)
		inboxColumns.add(TableConstants.WFTASK_CREATEDDATE_COLUMN.getName());		// 생성일자
		inboxColumns.add(TableConstants.WFTASK_ENDDATE_COLUMN.getName());			// 완료일자
		inboxColumns.add(TableConstants.WFTASK_FROMUSER_COLUMN.getName());			// FromUser (위임자)
		inboxColumns.add(TableConstants.WFTASK_ACTIVITYNAME_COLUMN.getName());		// 액티비티
		inboxColumns.add(TableConstants.WFTASK_TASKGROUPID_COLUMN.getName());		// Task 유형이 Group Vote 일 경우 
		inboxColumns.add(TableConstants.WFTASK_TASKDEFINITIONNAME_COLUMN.getName());	// Task Definition 명
		inboxColumns.add(TableConstants.WFTASK_PROCESSID_COLUMN.getName()); 			// 프로세스 아이디
		inboxColumns.add(TableConstants.WFTASK_PROCESSNAME_COLUMN.getName());
		inboxColumns.add(TableConstants.WFTASK_TEXTATTRIBUTE1_COLUMN.getName());		// DocType
		inboxColumns.add(TableConstants.WFTASK_TEXTATTRIBUTE2_COLUMN.getName());		// DocNum
		inboxColumns.add(TableConstants.WFTASK_DATEATTRIBUTE1_COLUMN.getName());		// Drafting Date
		
		
		// 화면상에 테이블 컬럼명을 설정한다. (JSP에서 동적으로 컬럼을 설정하기 위함이며, 선택사항임.)
		List<String> inboxColumnLabels = new ArrayList<String>();
		inboxColumnLabels.add("Title");
		inboxColumnLabels.add("Assign Users");
		inboxColumnLabels.add("State");
		inboxColumnLabels.add("Start Date");
		inboxColumnLabels.add("End Date");
		inboxColumnLabels.add("Lead Time");
		
		// 화면에서 호출할 액션 리스트를 정의한다.
		List<OptionalInfo> optionalInfo = new ArrayList<OptionalInfo>();
		optionalInfo.add(ITaskQueryService.OptionalInfo.ALL_ACTIONS); // actions do not needed for listing page
		
		
		
		// 검색 조건을 저장한다.
		Predicate predicate = null;
		// 값 안나옴, 검토필요
		//Map<String, String> mapState = WorkflowUtility.getFilterCodeList(TableConstants.WFTASK_STATE_COLUMN.getName(), wfCtx.getIsAdmin(), wfCtx.getLocale());
		
		
		// 상태 조회
		if(!"".equals(params.get(TableConstants.WFTASK_STATE_COLUMN.getName())) && params.get(TableConstants.WFTASK_STATE_COLUMN.getName()) != null)
			predicate = WorkflowUtility.setPredicate(predicate, TableConstants.WFTASK_STATE_COLUMN, Predicate.OP_EQ, params.get(TableConstants.WFTASK_STATE_COLUMN.getName()));
		else
			predicate = WorkflowUtility.setPredicate(predicate, TableConstants.WFTASK_STATE_COLUMN, Predicate.OP_EQ, IWorkflowConstants.TASK_STATE_ASSIGNED);
		
		// 제목조회
		if(!"".equals(params.get(TableConstants.WFTASK_TITLE_COLUMN.getName())) && params.get(TableConstants.WFTASK_TITLE_COLUMN.getName()) != null)
			predicate = WorkflowUtility.setPredicate(predicate, TableConstants.WFTASK_TITLE_COLUMN, Predicate.OP_LIKE, "%"+params.get(TableConstants.WFTASK_TITLE_COLUMN.getName())+"%", true);
		
		/*
		// 검색 검토 필요
        if("".equals(params.get(TableConstants.WFTASK_STATE_COLUMN.getName()))){
        	
        	Predicate innerPredicate_state = null;
        	Object [] stateArr =  mapState.keySet().toArray();

        	for(int i=0;i<stateArr.length;i++){
    			log.debug("state:"+ stateArr[i]);
        		innerPredicate_state = WorkflowUtility.setPredicate(innerPredicate_state, Predicate.OR, TableConstants.WFTASK_STATE_COLUMN, Predicate.OP_EQ, stateArr[i]);
        	}
        	predicate = new Predicate(predicate, Predicate.AND, innerPredicate_state);

        }else {
        	predicate = WorkflowUtility.setPredicate(predicate, TableConstants.WFTASK_STATE_COLUMN, Predicate.OP_EQ, params.get(TableConstants.WFTASK_STATE_COLUMN.getName()));
        }
        */
        // 날짜 검색
        if(!"".equals(params.get("fromDate")) && params.get("fromDate") != null) {
        	Calendar fromDate = WorkflowUtility.parseDateString(params.get("fromDate") + " 00:00", wfCtx.getLocale(), wfCtx.getTimeZone());
        	predicate = WorkflowUtility.setPredicate(predicate, TableConstants.WFTASK_CREATEDDATE_COLUMN, Predicate.OP_GTE, fromDate.getTime());
        }
        
        if(!"".equals(params.get("toDate")) && params.get("fromDate") != null) {
        	Calendar toDate = WorkflowUtility.parseDateString(params.get("toDate") + " 00:00", wfCtx.getLocale(), wfCtx.getTimeZone());
        	toDate.add(Calendar.DATE, 1);
        	predicate = WorkflowUtility.setPredicate(predicate, TableConstants.WFTASK_CREATEDDATE_COLUMN, Predicate.OP_LT, toDate.getTime());
        }
        
        //predicate = WorkflowUtility.setPredicate(predicate, TableConstants.WFTASK_TEXTATTRIBUTE1_COLUMN, Predicate.OP_EQ, params.get("docType"));
        
        Ordering ordering = null;
        
        if(!"".equals(params.get(OracleConstants.PARAM.PAGE.SORT_FIELD)) && params.get(OracleConstants.PARAM.PAGE.SORT_FIELD) != null) {
        	// ordering
            ordering = WorkflowUtility.createTaskOrdering((String) params.get(OracleConstants.PARAM.PAGE.SORT_FIELD), (String) params.get(OracleConstants.PARAM.PAGE.SORT_ORDER));
        } else {
        	// ordering
            ordering = WorkflowUtility.createTaskOrdering(TableConstants.WFTASK_CREATEDDATE_COLUMN.getName(), OracleConstants.CODE.SORT_ORDER.DESCENDING);
        }
        
        // get IWorkflowServiceClient -> get ITaskQueryService -> execute queryTasks()
        
        ITaskQueryService.AssignmentFilter defaultAssignmentFilter = ITaskQueryService.AssignmentFilter.MY_AND_GROUP;//"My+Group";
        
        // 관리자 일 경우
        if(wfCtx.getIsAdmin() && !"".equals(params.get(TableConstants.WFTASK_ASSIGNEEUSERS_COLUMN.getName()))){
        	defaultAssignmentFilter = ITaskQueryService.AssignmentFilter.ADMIN;//Admin
        }
        
        //logger.debug("Worklist where string : "+ predicate.getString());
        
        List<Task> tasks = soaClient.getTaskQueryService().queryTasks(
				wfCtx
		        ,inboxColumns
		        ,optionalInfo
		        ,defaultAssignmentFilter
		        ,null
		        ,predicate // predicate
		        ,ordering
		        ,startRow
		        ,endRow);

        int totalCount = soaClient.getTaskQueryService().countTasks(wfCtx, defaultAssignmentFilter, null, predicate);
        params.put(OracleConstants.PARAM.PAGE.TOTAL_ROWS, Integer.toString(totalCount));
        /* 페이지 더보기 기능으로 할 경우
        boolean moreTasks = true;
        tasks = new ArrayList();
        int start = 1;
        int end = 200;
        while (moreTasks) {
          List someTasks = getTaskQueryService().queryTasks(
                    ctx,
                    columns,
                    null,    // additional info
                    aFilter, // asssignment filter
                    null,    // keywords
                    pred,    // custom predicate
                    null,    // order
                    start,       // paging - start
                    end);      // paging - end
          tasks.addAll(someTasks);
          if (someTasks.size() < 200) {
            moreTasks = false;
          } else {
            start += 200;
            end += 200;
          }
       } */
        
        logger.debug("worklist task size : "+ tasks.size());
        
     // iterate over tasks and build return data
        List<TaskVO> result = new ArrayList<TaskVO>();
        for (int i = 0; i < tasks.size(); i++) {
          Task task = (Task)tasks.get(i);
          
          TaskVO taskVO = new TaskVO();
          DateFormat df = new SimpleDateFormat("yyyy-MM-dd hh:mm");
          
          taskVO.setPartition(task.getSca().getApplicationName());
          taskVO.setNumber(task.getSystemAttributes().getTaskNumber());
          taskVO.setTitle(CommonUtility.notNull(task.getTitle()));
          taskVO.setId(task.getSystemAttributes().getTaskId());
          taskVO.setCreateDate(WorkflowUtility.getTimeZoneBasedDateString(df, task.getSystemAttributes().getCreatedDate(), wfCtx.getTimeZone()));
          taskVO.setEndDate(WorkflowUtility.getTimeZoneBasedDateString(df, task.getSystemAttributes().getEndDate(), wfCtx.getTimeZone()));
          taskVO.setOutcome(task.getSystemAttributes().getOutcome());
          taskVO.setPriority(task.getPriority());
          taskVO.setState(task.getSystemAttributes().getState());
          taskVO.setParticipantName(task.getSystemAttributes().getParticipantName());
          taskVO.setAssigneeUsers(task.getCreatorDisplayName());
          taskVO.setAssigneeUsers(WorkflowUtility.getAssigneeString(task));
          taskVO.setAssigneeDisplayName(WorkflowUtility.getAssigneeDisplayNameString(task));
          taskVO.setCompositeName(task.getSca().getCompositeName());
          taskVO.setActivityName(task.getSystemAttributes().getActivityName());
          taskVO.setProcessName(task.getProcessInfo().getProcessName());
          //taskVO.setProcessDn(task.getSca().getApplicationName() + "/" + task.getSca(). + "!" + task.getProcessInfo().getProcessVersion() + "*/" + task.getProcessInfo().getProcessName());
          taskVO.setTextAttribute1(task.getSystemMessageAttributes().getTextAttribute1());
          taskVO.setTextAttribute2(task.getSystemMessageAttributes().getTextAttribute2());
          //taskVO.setDateAttribute1(task.getSystemMessageAttributes().getDateAttribute1());
          taskVO.setInstanceId(task.getProcessInfo().getInstanceId());
          //taskVO.setTaskDisplayUrl(WorklistUtil.getTaskDisplayURL(soaClient.getWorkflowServiceClient(), wfCtx, task, null, "worklist", null));
          
          result.add(taskVO);
          
          // Token 가져오는 부분 , BGF PoC 용, 업무 화면이 별도 구성되어 있고 taskId와 token을 넘겨야 함... 기본 task list 와 연결을 할 때 이런식으로 함..
          //IBPMContext adminBpmCtx = soaClient.getBPMUserAuthenticationService().authenticate("weblogic", "welcome1".toCharArray(), null);
          //IBPMContext bpmCtx = soaClient.getBPMUserAuthenticationService().authenticateOnBehalfOf(adminBpmCtx, wfCtx.getUser());
          
          //logger.debug("wfCtx.token : "+ wfCtx.getToken());
          //logger.debug("bpmCtx.token : "+ bpmCtx.getToken());
          
          //taskVO.setBpmCtxToken(bpmCtx.getToken());
          //bpmWorklistTaskId=&bpmWorklistContext
          
          
        }

        // sort the list by priority
        //Collections.sort(result, new MTaskComparator());

        return result;
	}

	@Override
	public TaskVO getTaskDetail(IWorkflowContext wfCtx, int taskNumber) throws Exception {
Task task = soaClient.getTaskQueryService().getTaskDetailsByNumber(wfCtx, taskNumber);
		
		logger.debug("============= Task "+task.getSystemAttributes().getTaskNumber()+"=============");
		//XmlUtility.print();
		
		Element xPayload = task.getPayloadAsElement();
		
		if (xPayload == null) {
		      logger.debug("payload is null");
		} /*else {
			processdoc = WorkflowUtility.getJaxbPayload(xPayload);
		}*/
		
		List<ActionType> customActions = task.getSystemAttributes().getCustomActions();
		Map<String, String> cActions = new HashMap<String, String>();
		
		if(customActions != null && customActions.size() > 0) {
			for (int actionIdx=0; actionIdx < customActions.size(); actionIdx++) {
				ActionType actionType = (ActionType) customActions.get(actionIdx);
				
				cActions.put(actionType.getAction(), actionType.getDisplayName());
				
	        }
		}
			
		List<ActionType> systemActions = task.getSystemAttributes().getSystemActions();
		Map<String, String> sActions = new HashMap<String, String>();
		
		if(systemActions != null && systemActions.size() > 0) {
			for (int actionIdx=0; actionIdx <  systemActions.size(); actionIdx++) {
				ActionType actionType = (ActionType) systemActions.get(actionIdx);
				
				sActions.put(actionType.getAction(), actionType.getDisplayName());
				
	        }
		}
		
		TaskVO taskVO = new TaskVO();
		
		taskVO.setNumber(task.getSystemAttributes().getTaskNumber());
		taskVO.setId(task.getSystemAttributes().getTaskId());
		taskVO.setTitle(task.getTitle());
		//taskVO.setPayload(processdoc);
		taskVO.setXpalyload(xPayload);
		taskVO.setCustomActions(cActions);
		taskVO.setSystemActions(sActions);
		taskVO.setInstanceId(task.getProcessInfo().getInstanceId());
		
		logger.debug("getTaskDefinitionId : " + task.getTaskDefinitionId());
		logger.debug("getApplicationName : " + task.getSca().getApplicationName());
		logger.debug("getTaskNamespace : " + task.getSystemAttributes().getTaskNamespace());
		logger.debug("getCompositeVersion : " + task.getSca().getCompositeVersion());
		logger.debug("partition : " + task.getSca().getCompositeDN().substring(0,task.getSca().getCompositeDN().indexOf("/")));
		
		//taskdefinitionid, applicationname, formname
		List<TaskDisplayInfoType> taskDisplayInfoTypes = soaClient.getWorkflowServiceClient().getRuntimeConfigService().getTaskDisplayInfoByTaskDefinitionId(wfCtx, task.getTaskDefinitionId(), null, null);
		
		//ps6에서 deprecate 됨
		//List<TaskDisplayInfoType> taskDisplayInfoTypes = soaClient.getWorkflowServiceClient().getRuntimeConfigService().getTaskDisplayInfoByTaskDefinitionId(wfCtx, task.getTaskDefinitionId(), null);
		//List<TaskDisplayInfoType> taskDisplayInfoTypes = soaClient.getWorkflowServiceClient().getRuntimeConfigService().getTaskDisplayInfo(wfCtx, task.getSystemAttributes().getTaskNamespace(), task.getSca().getCompositeVersion(), task.getSca().getCompositeDN().substring(0,task.getSca().getCompositeDN().indexOf("/")), null);
		
		// 여러개 등록될 수 있음... 멀티로 등록되는 부분 생기면 추가 함...
		for(TaskDisplayInfoType taskDisplayInfoType : taskDisplayInfoTypes) {
			logger.debug("getHostname : " + taskDisplayInfoType.getHostname());
			logger.debug("getHttpPort : " + taskDisplayInfoType.getHttpPort());
			logger.debug("getUri : " + taskDisplayInfoType.getUri());
			logger.debug("getApplicationName : " + taskDisplayInfoType.getApplicationName());
			logger.debug("getFormDisplayName : " + taskDisplayInfoType.getFormDisplayName());
			logger.debug("getFormName : " + taskDisplayInfoType.getFormName());
			
			taskVO.setTaskDisplayUrl("http://"+taskDisplayInfoType.getHostname() + ":" + taskDisplayInfoType.getHttpPort() + taskDisplayInfoType.getUri());
			taskVO.setTaskApplicationName(taskDisplayInfoType.getApplicationName());
			taskVO.setTaskUri(taskDisplayInfoType.getUri());
			taskVO.setTaskFormDisplayName(taskDisplayInfoType.getFormDisplayName());
			taskVO.setTaskFormName(taskDisplayInfoType.getFormName());
		}
		return taskVO;
	}
	
	@Override
	public void doAction(IWorkflowContext wfCtx, Map<String, String> params) throws Exception {
		String taskNumber = (String) params.get("tasknumber");
		String outcome = (String) params.get("outcome");
		Task task = soaClient.getTaskQueryService().getTaskDetailsByNumber(wfCtx, Integer.parseInt(taskNumber));
		
		soaClient.getWorkflowServiceClient().getTaskService().updateTaskOutcome(wfCtx, task, outcome);
	}
	
}
